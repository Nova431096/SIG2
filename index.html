<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SIG</title>
<style>
:root{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.35}
body{margin:0;padding:24px;background:#0b0f14;color:#e7eef7}
.wrap{max-width:980px;margin:0 auto}
h1{margin:0 0 14px;font-size:22px}
.card{background:#121a24;border:1px solid #213042;border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
.row{display:grid;gap:10px}
@media(min-width:860px){.row2{grid-template-columns:1fr 1fr}}
label{font-size:12px;color:#a9b7c7;display:block;margin:0 0 6px}
input,textarea,button,select{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #2a3b52;background:#0f1520;color:#e7eef7;padding:10px 12px;font:inherit}
textarea{min-height:110px;resize:vertical}
button{cursor:pointer;background:#1b2a3d;border-color:#2f4764}
button:hover{background:#22344b}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.tabs{display:flex;gap:10px;margin:14px 0}
.tab{flex:1;padding:10px;border-radius:10px;border:1px solid #2a3b52;background:#0f1520;color:#e7eef7;cursor:pointer;text-align:center}
.tab.active{background:#1b2a3d;border-color:#2f4764}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.actions button{width:auto;padding:10px 14px}
.small{font-size:12px;color:#a9b7c7;margin-top:8px}
.ok{color:#73e6a5}
.warn{color:#ffcc66}
.err{color:#ff7b7b}
.hint{color:#a9b7c7;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
<h1>SIG</h1>
<div class="card">
  <div class="row row2">
    <div>
      <label>Shared Key</label>
      <input id="key" class="mono">
    </div>
    <div>
      <label>Version</label>
      <div class="tabs" style="margin:0">
        <button class="tab active" id="tabSIG1" type="button">SIG1</button>
        <button class="tab" id="tabSIG2" type="button">SIG2</button>
      </div>
    </div>
  </div>

  <!-- SIG1 panel -->
  <div id="panelSIG1" style="margin-top:14px;">
    <div class="tabs">
      <button class="tab active" id="tabSIG1Dec" type="button">Decrypt</button>
      <button class="tab" id="tabSIG1Enc" type="button">Encrypt</button>
    </div>
    <div id="sig1Dec">
      <label>Payload</label>
      <textarea id="sig1Payload" class="mono"></textarea>
      <div class="actions">
        <button id="sig1BtnDec" type="button">Decrypt</button>
        <button id="sig1BtnClear" type="button">Clear</button>
        <button id="sig1BtnCopyClean" type="button">Copy Clean</button>
      </div>
      <label style="margin-top:12px;">Raw Output</label>
      <textarea id="sig1OutRaw" class="mono" readonly></textarea>
      <label style="margin-top:12px;">Cleaned Output (X â†’ space)</label>
      <textarea id="sig1OutClean" readonly></textarea>
      <div id="sig1Status" class="small"></div>
    </div>
    <div id="sig1Enc" style="display:none;">
      <label>Plaintext (Aâ€“Z only; use X for spaces)</label>
      <textarea id="sig1Plain" class="mono"></textarea>
      <div class="actions">
        <button id="sig1BtnEnc" type="button">Encrypt</button>
        <button id="sig1BtnNonce" type="button">New Nonce</button>
        <button id="sig1BtnCopyPayload" type="button">Copy Payload</button>
      </div>
      <div class="row row2" style="margin-top:12px;">
        <div>
          <label>Nonce</label>
          <input id="sig1Nonce" class="mono" maxlength="6">
        </div>
        <div>
          <label>Payload</label>
          <input id="sig1PayloadOut" class="mono" readonly>
        </div>
      </div>
      <label style="margin-top:12px;">Ciphertext</label>
      <textarea id="sig1Cipher" class="mono" readonly></textarea>
      <div id="sig1StatusEnc" class="small"></div>
    </div>
  </div>

  <!-- SIG2 panel -->
  <div id="panelSIG2" style="display:none;margin-top:14px;">
    <div class="tabs">
      <button class="tab active" id="tabSIG2Dec" type="button">Decrypt</button>
      <button class="tab" id="tabSIG2Enc" type="button">Encrypt</button>
    </div>
    <div id="sig2Dec">
      <label>Payload</label>
      <textarea id="sig2Payload" class="mono"></textarea>
      <div class="row row2" style="margin-top:12px;">
        <div>
          <label>Salt (optional)</label>
          <input id="sig2SaltDec" class="mono">
        </div>
        <div>
          <label>Detected Mode</label>
          <input id="sig2ModeDec" class="mono" readonly>
        </div>
      </div>
      <div class="actions">
        <button id="sig2BtnDec" type="button">Decrypt</button>
        <button id="sig2BtnClear" type="button">Clear</button>
        <button id="sig2BtnCopyPlain" type="button">Copy Output</button>
      </div>
      <label style="margin-top:12px;">Output</label>
      <textarea id="sig2Out" readonly></textarea>
      <div id="sig2Status" class="small"></div>
      <div class="hint" style="margin-top:10px;">
        SIG2 supports letters, digits, space, and common punctuation. Provide the correct salt if used.
      </div>
    </div>
    <div id="sig2Enc" style="display:none;">
      <label>Plaintext</label>
      <textarea id="sig2Plain"></textarea>
      <div class="row row2" style="margin-top:12px;">
        <div>
          <label>Salt (optional)</label>
          <input id="sig2SaltEnc" class="mono">
        </div>
        <div>
          <label>Mode</label>
          <select id="sig2ModeEnc">
            <option value="A">A - Normal</option>
            <option value="B">B - Aggressive stepping</option>
            <option value="C">C - Alt reflector</option>
            <option value="D">D - Emoji/Symbol</option>
          </select>
        </div>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button id="sig2BtnEnc" type="button">Encrypt</button>
        <button id="sig2BtnNonce" type="button">New Nonce</button>
        <button id="sig2BtnCopyPayload" type="button">Copy Payload</button>
      </div>
      <div class="row row2" style="margin-top:12px;">
        <div>
          <label>Nonce</label>
          <input id="sig2Nonce" class="mono" maxlength="6">
        </div>
        <div>
          <label>Tag</label>
          <input id="sig2Tag" class="mono" readonly maxlength="6">
        </div>
      </div>
      <label style="margin-top:12px;">Payload</label>
      <input id="sig2PayloadOut" class="mono" readonly>
      <label style="margin-top:12px;">Ciphertext</label>
      <textarea id="sig2Cipher" class="mono" readonly></textarea>
      <div id="sig2StatusEnc" class="small"></div>
    </div>
  </div>
</div>
</div>

<script>
/* ======= Shared functions ======= */
const A_CODE = "A".charCodeAt(0);
const el = (id)=> document.getElementById(id);
function nonce6(){
  const b = new Uint8Array(6);
  crypto.getRandomValues(b);
  let s = "";
  for(let i=0;i<6;i++) s += String.fromCharCode(A_CODE + (b[i] % 26));
  return s;
}
async function sha256Bytes(str){
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest("SHA-256", enc);
  return new Uint8Array(hash);
}
function bytesToHex(bytes){
  let out = "";
  for(const b of bytes) out += b.toString(16).padStart(2,"0");
  return out;
}

/* ======= SIG1 functions (unchanged) ======= */
function cleanAZ(s){ return (s||"").toUpperCase().replace(/[^A-Z]/g,""); }
const mod26 = (n)=> (n%26+26)%26;
const toIdx26 = (c)=> c.charCodeAt(0)-A_CODE;
const toCh26 = (i)=> String.fromCharCode(A_CODE + i);
async function* byteStream(seedStr){
  let block = await sha256Bytes(seedStr);
  while(true){
    for(let i=0;i<block.length;i++) yield block[i];
    block = await crypto.subtle.digest("SHA-256", block).then(b=>new Uint8Array(b));
  }
}
async function buildSIG1(key, nonce){
  const stream = byteStream(`SIG1|${key.trim()}|${nonce}`);
  const nextByte = async()=> (await stream.next()).value;
  async function randInt(n){
    const lim = Math.floor(256/n)*n;
    while(true){
      const b = await nextByte();
      if(b < lim) return b % n;
    }
  }
  async function makeRotor(){
    const arr = Array.from({length:26},(_,i)=>i);
    for(let i=25;i>0;i--){
      const j = await randInt(i+1);
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  const r0=await makeRotor(), r1=await makeRotor(), r2=await makeRotor();
  const inv=(r)=>{ const ir=new Array(26); for(let i=0;i<26;i++) ir[r[i]]=i; return ir; };
  const ir0=inv(r0), ir1=inv(r1), ir2=inv(r2);
  async function makeRef(){
    const ref = new Array(26).fill(-1);
    const u = Array.from({length:26},(_,i)=>i);
    while(u.length){
      const a = u.splice(await randInt(u.length),1)[0];
      if((await randInt(100))<20 || !u.length){ ref[a]=a; continue; }
      const b = u.splice(await randInt(u.length),1)[0];
      ref[a]=b; ref[b]=a;
    }
    return ref;
  }
  const ref = await makeRef();
  const o0=(await nextByte())%26, o1=(await nextByte())%26, o2=(await nextByte())%26;
  return {r0,r1,r2,ir0,ir1,ir2,ref,o0,o1,o2};
}
function stepSIG1(s){
  s.o2 = (s.o2+1)%26;
  if(s.o2===0){
    s.o1 = (s.o1+1)%26;
    if(s.o1===0) s.o0 = (s.o0+1)%26;
  }
}
function rotorFwd26(x,r,o){ const y = r[mod26(x+o)]; return mod26(y-o); }
function rotorInv26(x,ir,o){ const y = ir[mod26(x+o)]; return mod26(y-o); }
function xformSIG1(x,s){
  x = rotorFwd26(x,s.r0,s.o0);
  x = rotorFwd26(x,s.r1,s.o1);
  x = rotorFwd26(x,s.r2,s.o2);
  x = s.ref[x];
  x = rotorInv26(x,s.ir2,s.o2);
  x = rotorInv26(x,s.ir1,s.o1);
  x = rotorInv26(x,s.ir0,s.o0);
  return x;
}
async function sig1Crypt(key, nonce, text){
  const s = await buildSIG1(key, nonce);
  const input = cleanAZ(text);
  let out="";
  for(const ch of input){
    const idx=toIdx26(ch);
    stepSIG1(s);
    out+=toCh26(xformSIG1(idx,s));
  }
  return out;
}

/* ======= SIG2 configuration ======= */
const SIG2_MODES = {
  A: {
    alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789.,?!:;'-()/@#&",
    mStepDiv: 7,
    lStepDiv: 11,
    roffStep: 1,
  },
  B: {
    alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789.,?!:;'-()/@#&",
    mStepDiv: 3,
    lStepDiv: 5,
    roffStep: 1,
  },
  C: {
    alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789.,?!:;'-()/@#&",
    mStepDiv: 7,
    lStepDiv: 11,
    roffStep: 2,
  },
  D: {
    alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789.,?!:;'-()/@#&âˆ†Î£Î Î¦Î©Î›Î˜Î“Î¨Î›Î¨ðŸ™ƒðŸ˜ŠðŸŒŸðŸ”¥ðŸ’§â„ï¸",
    mStepDiv: 7,
    lStepDiv: 11,
    roffStep: 1,
  },
};
function buildSig2Map(alpha){
  const map = new Map();
  for(let i=0;i<alpha.length;i++) map.set(alpha[i], i);
  return map;
}

async function buildSIG2(key, nonce, salt, mode){
  const cfg = SIG2_MODES[mode] || SIG2_MODES.A;
  const alpha = cfg.alphabet;
  const stream = byteStream(`SIG2|${key.trim()}|${salt||""}|${nonce}|MODE:${mode}|ALPHA:${alpha}`);
  const nextByte = async()=> (await stream.next()).value;
  async function randInt(n){
    const lim = Math.floor(256/n)*n;
    while(true){
      const b = await nextByte();
      if(b < lim) return b % n;
    }
  }
  async function makePerm(n){
    const arr = Array.from({length:n},(_,i)=>i);
    for(let i=n-1;i>0;i--){
      const j = await randInt(i+1);
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  const N = alpha.length;
  const r0=await makePerm(N), r1=await makePerm(N), r2=await makePerm(N);
  const inv = (r)=>{ const ir=new Array(N); for(let i=0;i<N;i++) ir[r[i]]=i; return ir; };
  const ir0=inv(r0), ir1=inv(r1), ir2=inv(r2);
  async function makeRef(){
    const ref = new Array(N).fill(-1);
    const u = Array.from({length:N},(_,i)=>i);
    while(u.length){
      const a = u.splice(await randInt(u.length),1)[0];
      if((await randInt(100))<15 || !u.length){ ref[a]=a; continue; }
      const b = u.splice(await randInt(u.length),1)[0];
      ref[a]=b; ref[b]=a;
    }
    return ref;
  }
  const ref=await makeRef();
  const o0=(await nextByte())%N, o1=(await nextByte())%N, o2=(await nextByte())%N;
  const roff=(await nextByte())%N;
  return {cfg,alpha,r0,r1,r2,ir0,ir1,ir2,ref,o0,o1,o2,roff};
}
function stepSIG2(state){
  const N = state.alpha.length;
  const cfg = state.cfg;
  state.o2 = (state.o2 + 1) % N;
  state.roff = (state.roff + cfg.roffStep) % N;
  if(state.o2 === 0 || (state.o2 % cfg.mStepDiv) === 0){
    state.o1 = (state.o1 + 1) % N;
  }
  if(state.o1 === 0 || (state.o1 % cfg.lStepDiv) === 0){
    state.o0 = (state.o0 + 1) % N;
  }
}
function rotorFwdN(x, rotor, off, N){ const y = rotor[(x+off)%N]; return (y - off + N)%N; }
function rotorInvN(x, ir, off, N){ const y = ir[(x+off)%N]; return (y - off + N)%N; }
function reflectN(x, ref, roff, N){ return (ref[(x+roff)%N] - roff + N)%N; }
async function sig2Crypt(key, nonce, salt, mode, text){
  const state = await buildSIG2(key, nonce, salt, mode);
  const alpha = state.alpha;
  const map = buildSig2Map(alpha);
  let out = "";
  const input = cleanSIG2Text(text, map);
  for(const ch of input){
    stepSIG2(state);
    const idx = map.get(ch);
    let x = idx;
    x = rotorFwdN(x, state.r0, state.o0, alpha.length);
    x = rotorFwdN(x, state.r1, state.o1, alpha.length);
    x = rotorFwdN(x, state.r2, state.o2, alpha.length);
    x = reflectN(x, state.ref, state.roff, alpha.length);
    x = rotorInvN(x, state.ir2, state.o2, alpha.length);
    x = rotorInvN(x, state.ir1, state.o1, alpha.length);
    x = rotorInvN(x, state.ir0, state.o0, alpha.length);
    out += alpha[x];
  }
  return out;
}
function cleanSIG2Text(s, map){
  const up = (s||"").toUpperCase();
  let out="";
  for(const ch of up){
    if(map.has(ch)) out+=ch;
  }
  return out;
}
async function sig2Tag6(key, nonce, salt, mode, normalized){
  const cfg = SIG2_MODES[mode] || SIG2_MODES.A;
  const alpha = cfg.alphabet;
  const bytes = await sha256Bytes(`SIG2|TAG|${key.trim()}|${salt||""}|${nonce}|${mode}|${alpha}|${normalized}`);
  return bytesToHex(bytes).slice(0,6).toUpperCase();
}

/* ======= UI logic ======= */
function setVersion(v){
  document.getElementById("tabSIG1").classList.toggle("active", v==="SIG1");
  document.getElementById("tabSIG2").classList.toggle("active", v==="SIG2");
  document.getElementById("panelSIG1").style.display = v==="SIG1" ? "" : "none";
  document.getElementById("panelSIG2").style.display = v==="SIG2" ? "" : "none";
}
document.getElementById("tabSIG1").addEventListener("click", ()=>setVersion("SIG1"));
document.getElementById("tabSIG2").addEventListener("click", ()=>setVersion("SIG2"));

function setSIG1Mode(m){
  document.getElementById("tabSIG1Dec").classList.toggle("active", m==="dec");
  document.getElementById("tabSIG1Enc").classList.toggle("active", m==="enc");
  document.getElementById("sig1Dec").style.display = m==="dec" ? "" : "none";
  document.getElementById("sig1Enc").style.display = m==="enc" ? "" : "none";
}
document.getElementById("tabSIG1Dec").addEventListener("click", ()=>setSIG1Mode("dec"));
document.getElementById("tabSIG1Enc").addEventListener("click", ()=>setSIG1Mode("enc"));

function setSIG2ModePanel(m){
  document.getElementById("tabSIG2Dec").classList.toggle("active", m==="dec");
  document.getElementById("tabSIG2Enc").classList.toggle("active", m==="enc");
  document.getElementById("sig2Dec").style.display = m==="dec" ? "" : "none";
  document.getElementById("sig2Enc").style.display = m==="enc" ? "" : "none";
}
document.getElementById("tabSIG2Dec").addEventListener("click", ()=>setSIG2ModePanel("dec"));
document.getElementById("tabSIG2Enc").addEventListener("click", ()=>setSIG2ModePanel("enc"));

/* SIG1 actions */
document.getElementById("sig1BtnNonce").addEventListener("click", ()=>{ el("sig1Nonce").value = nonce6(); });
document.getElementById("sig1BtnEnc").addEventListener("click", async ()=>{
  try{
    el("sig1StatusEnc").textContent="";
    const key = el("key").value || "";
    let nonce = cleanAZ(el("sig1Nonce").value || "");
    if(nonce.length !== 6){ nonce = nonce6(); el("sig1Nonce").value = nonce; }
    const pt = el("sig1Plain").value || "";
    const ct = await sig1Crypt(key, nonce, pt);
    el("sig1Cipher").value = ct;
    el("sig1PayloadOut").value = `SIG1.${nonce}.${ct}`;
    el("sig1StatusEnc").innerHTML = `<span class="ok">Encrypted</span> â€¢ Len: ${ct.length}`;
  }catch(e){
    el("sig1StatusEnc").innerHTML = `<span class="err">${e.message}</span>`;
  }
});
document.getElementById("sig1BtnCopyPayload").addEventListener("click", ()=>copyText(el("sig1PayloadOut").value));
document.getElementById("sig1BtnCopyClean").addEventListener("click", ()=>copyText(el("sig1OutClean").value));
document.getElementById("sig1BtnDec").addEventListener("click", async ()=>{
  try{
    el("sig1Status").textContent="";
    const key = el("key").value || "";
    const raw = (el("sig1Payload").value || "").trim().toUpperCase().replace(/\s+/g,"");
    const parts = raw.split(".");
    if(parts.length !== 3 || parts[0] !== "SIG1") throw new Error("Expected: SIG1.<NONCE6>.<CIPHERTEXT>");
    const nonce = cleanAZ(parts[1]);
    const ct = cleanAZ(parts[2]);
    if(nonce.length !== 6) throw new Error("SIG1 nonce must be 6 letters.");
    const pt = await sig1Crypt(key, nonce, ct);
    el("sig1OutRaw").value = pt;
    el("sig1OutClean").value = pt.replace(/X/g," ");
    el("sig1Status").innerHTML = `<span class="ok">Decrypted</span> â€¢ Len: ${pt.length}`;
  }catch(e){
    el("sig1Status").innerHTML = `<span class="err">${e.message}</span>`;
  }
});
document.getElementById("sig1BtnClear").addEventListener("click", ()=>{
  el("sig1Payload").value="";
  el("sig1OutRaw").value="";
  el("sig1OutClean").value="";
  el("sig1Status").textContent="";
});

/* SIG2 actions */
document.getElementById("sig2BtnNonce").addEventListener("click", ()=>{ el("sig2Nonce").value = nonce6(); });
document.getElementById("sig2BtnEnc").addEventListener("click", async ()=>{
  try{
    el("sig2StatusEnc").textContent="";
    const key = el("key").value || "";
    let nonce = cleanAZ(el("sig2Nonce").value || "");
    if(nonce.length !== 6){ nonce = nonce6(); el("sig2Nonce").value = nonce; }
    const salt = el("sig2SaltEnc").value || "";
    const mode = el("sig2ModeEnc").value || "A";
    const plainRaw = el("sig2Plain").value || "";
    const cfg = SIG2_MODES[mode] || SIG2_MODES.A;
    const map = buildSig2Map(cfg.alphabet);
    const plainNorm = cleanSIG2Text(plainRaw, map);
    if(!plainNorm) throw new Error("Plaintext is empty after cleaning.");
    const ct = await sig2Crypt(key, nonce, salt, mode, plainNorm);
    const tag = await sig2Tag6(key, nonce, salt, mode, plainNorm);
    el("sig2Cipher").value = ct;
    el("sig2Tag").value = tag;
    el("sig2PayloadOut").value = `SIG2${mode}.${nonce}.${tag}.${ct}`;
    el("sig2StatusEnc").innerHTML = `<span class="ok">Encrypted</span> â€¢ Len: ${ct.length}`;
  }catch(e){
    el("sig2StatusEnc").innerHTML = `<span class="err">${e.message}</span>`;
  }
});
document.getElementById("sig2BtnCopyPayload").addEventListener("click", ()=>copyText(el("sig2PayloadOut").value));
document.getElementById("sig2BtnCopyPlain").addEventListener("click", ()=>copyText(el("sig2Out").value));
document.getElementById("sig2BtnDec").addEventListener("click", async ()=>{
  try{
    el("sig2Status").textContent="";
    const key = el("key").value || "";
    const raw = (el("sig2Payload").value || "").trim().toUpperCase().replace(/\s+/g,"");
    const parts = raw.split(".");
    if(parts.length < 4 || !parts[0].startsWith("SIG2")) throw new Error("Expected: SIG2<MODE>.<NONCE6>.<TAG6>.<CIPHERTEXT>");
    const prefix = parts[0];
    const mode = prefix.length > 4 ? prefix.substring(4,5) : "A";
    const nonce = cleanAZ(parts[1]);
    const tag = parts[2].toUpperCase();
    const ct = parts.slice(3).join(".");
    if(nonce.length !== 6) throw new Error("Nonce must be 6 letters.");
    const salt = el("sig2SaltDec").value || "";
    el("sig2ModeDec").value = mode;
    const cfg = SIG2_MODES[mode] || SIG2_MODES.A;
    const map = buildSig2Map(cfg.alphabet);
    const pt = await sig2Crypt(key, nonce, salt, mode, ct);
    el("sig2Out").value = pt;
    const ptNorm = cleanSIG2Text(pt, map);
    const check = await sig2Tag6(key, nonce, salt, mode, ptNorm);
    if(check === tag){
      el("sig2Status").innerHTML = `<span class="ok">Decrypted â€¢ Tag OK</span> â€¢ Len: ${pt.length}`;
    }else{
      el("sig2Status").innerHTML = `<span class="warn">Decrypted but TAG FAILED</span> â€” wrong key, wrong salt, or modified message. Expected <span class="mono">${check}</span>, got <span class="mono">${tag}</span>.`;
    }
  }catch(e){
    el("sig2Status").innerHTML = `<span class="err">${e.message}</span>`;
  }
});
document.getElementById("sig2BtnClear").addEventListener("click", ()=>{
  el("sig2Payload").value="";
  el("sig2Out").value="";
  el("sig2Status").textContent="";
  el("sig2ModeDec").value="";
});
/* Initialize defaults */
el("sig1Nonce").value = nonce6();
el("sig2Nonce").value = nonce6();
setVersion("SIG1");
setSIG1Mode("dec");
setSIG2ModePanel("dec");
</script>
</body>
</html>
